<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>自販機アンケート</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap');

      :root {
        --accent: #ff7eb6;
        --accent-2: #6c8cff;
        --border: #e5e7f0;
        --muted: #f7f8ff;
        --text: #1f2430;
        --shadow: 0 12px 28px rgba(61, 78, 255, 0.08);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: 'Noto Sans JP', 'Baloo 2', system-ui, -apple-system, sans-serif;
        background: radial-gradient(circle at 10% 20%, #fff3fb 0, #f1f6ff 45%, #ffffff 90%);
        color: var(--text);
      }

      .page {
        max-width: 1040px;
        margin: 0 auto;
        padding: 28px 16px 60px;
      }

      h1 {
        font-size: 30px;
        margin: 0 0 12px;
        letter-spacing: 0.02em;
      }

      h2 {
        margin: 4px 0 6px;
      }

      p.lead {
        margin: 0 0 18px;
        color: #3a3f52;
        line-height: 1.7;
      }

      header.hero {
        background: linear-gradient(120deg, rgba(255, 126, 182, 0.12), rgba(108, 140, 255, 0.12));
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 22px 20px 20px;
        box-shadow: var(--shadow);
      }

      .hero-badges {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #fff;
        color: var(--text);
        border: 1px solid var(--border);
        padding: 6px 12px;
        border-radius: 999px;
        font-weight: 600;
      }

      .pill.accent {
        background: #1f1f1f;
        color: #fff;
        border-color: transparent;
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
      }

      .pill.alt {
        background: #fff1f8;
        color: #ff4f9d;
        border-color: #ffd7eb;
      }

      section.block,
      .controls {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 18px 16px 20px;
        margin-top: 16px;
        box-shadow: var(--shadow);
      }

      .controls form {
        display: grid;
        gap: 12px;
      }

      #lineupContainer {
        margin-top: 16px;
        display: grid;
        gap: 16px;
      }

      .control-row {
        display: grid;
        gap: 12px;
      }

      @media (min-width: 768px) {
        .control-row {
          grid-template-columns: 1fr 1fr;
        }
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-weight: 700;
        color: #3a3f52;
      }

      select,
      textarea {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        font-size: 14px;
        font-family: inherit;
        background: #f9fafb;
      }

      textarea {
        min-height: 96px;
        resize: vertical;
      }

      .control-actions {
        display: flex;
        justify-content: flex-end;
      }

      button,
      .button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 12px 18px;
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: #fff;
        border-radius: 14px;
        font-weight: 800;
        text-decoration: none;
        border: none;
        cursor: pointer;
        box-shadow: 0 12px 24px rgba(255, 126, 182, 0.35);
        transition: 0.18s ease;
      }

      button.secondary,
      .button.secondary {
        background: #1f1f1f;
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.14);
      }

      button:hover,
      .button:hover {
        transform: translateY(-2px);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        flex-wrap: wrap;
      }

      .section-lead {
        margin: 0;
        color: #4a5066;
        line-height: 1.6;
        font-size: 14px;
      }

      .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-weight: 700;
        color: #8b92b2;
        font-size: 12px;
        margin: 0;
      }

      .card-grid {
        position: relative;
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        align-items: stretch;
      }

      .product-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .product-grid .product-card {
        flex: 0 0 220px;
      }

      .manufacturer-grid {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .card {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        background: linear-gradient(180deg, #ffffff 0%, #f7f8ff 60%, #eef1ff 100%);
        display: flex;
        flex-direction: column;
        gap: 10px;
        position: relative;
        box-shadow: 0 6px 18px rgba(22, 42, 97, 0.08);
        align-items: center;
        text-align: center;
      }

      .card.selectable {
        cursor: pointer;
        transition: 0.2s ease;
      }

      .card.selectable:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 22px rgba(31, 90, 201, 0.18);
      }

      .card.selected {
        border: 2px solid var(--accent-2);
        box-shadow: 0 14px 28px rgba(108, 140, 255, 0.25);
        background: linear-gradient(180deg, #f4f6ff 0%, #eaf0ff 60%, #eef3ff 100%);
      }

      .card.dimmed {
        filter: grayscale(0.8);
        opacity: 0.55;
      }

      .card h3,
      .card h4 {
        margin: 0;
        font-size: 15px;
      }

      .badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #fff;
        color: var(--accent);
        padding: 4px 8px;
        border-radius: 10px;
        border: 1px solid var(--accent);
        font-weight: 700;
        font-size: 12px;
      }

      .media-frame {
        width: 100%;
        aspect-ratio: 3 / 4;
        min-height: 160px;
        border-radius: 12px;
        background: linear-gradient(145deg, #fdf3ff, #f0f5ff);
        border: 1px solid var(--border);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 4px 10px rgba(255, 255, 255, 0.8);
      }

      .media-frame img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
        background: transparent;
      }

      .feature-list {
        list-style: none;
        padding: 0;
        margin: 6px 0 0;
        width: 100%;
        display: grid;
        gap: 8px;
      }

      .feature-item {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
        font-weight: 700;
        color: #1f2430;
      }

      .feature-badge {
        min-width: 56px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 800;
        border: 1px solid transparent;
      }

      .feature-badge.possible {
        background: #ebf1ff;
        color: #2f6bff;
        border-color: #cdd9ff;
      }

      .feature-badge.unavailable {
        background: #f3f4f7;
        color: #8c94ab;
        border-color: #dadee8;
      }

      .meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: #555;
        gap: 8px;
        width: 100%;
      }

      .price {
        font-size: 16px;
        font-weight: 800;
        color: #1e5ac9;
      }

      .maker {
        font-weight: 700;
        color: #34354a;
      }

      .empty {
        padding: 14px;
        background: var(--muted);
        border-radius: 10px;
        text-align: center;
        color: #3a3f52;
      }

      .note {
        color: #4b4f65;
        background: #fdf3ff;
        border: 1px dashed #ffc0df;
        padding: 10px 12px;
        border-radius: 12px;
        margin: 6px 0 10px;
      }

      .feature-table-wrapper {
        margin-top: 12px;
        overflow-x: auto;
      }

      .feature-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
      }

      .feature-table th,
      .feature-table td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }

      .feature-table tbody tr:last-child th,
      .feature-table tbody tr:last-child td {
        border-bottom: none;
      }

      .feature-table th {
        background: #f5f6fb;
        font-weight: 700;
      }

      @media (max-width: 600px) {
        h1 {
          font-size: 24px;
        }

        .media-frame {
          min-height: 180px;
        }
      }
    </style>
  </head>
  <body style="margin:auto 0;padding:auto 0;">
    <div class="page">
      <header class="hero">
        <div class="hero-badges">
          <span class="pill alt">１つ選ぶだけ</span>
        </div>
        <h1 id="pageTitle"></h1>
        <p id="pageLead" class="lead"></p>
      </header>

      <section id="controls" class="controls"></section>
      <section id="lineupContainer"></section>
    </div>

    <script>
      const makerFromTemplate = <?!= JSON.stringify(maker || '') ?>;
      const folderIdFromTemplate = <?!= JSON.stringify(folderId || '') ?>;

      const SURVEY_TITLE = '新オフィスの自販機を皆さんの投票で決めます！';
      const QUESTION1_DESCRIPTION = '４つのメーカーのうち、どれか一つ好きなメーカーを選んでください。';
      const LINEUP_INSTRUCTION = '商品ラインアップをクリックすると商品が確認できます。';
      const QUESTION2_DESCRIPTION =
        'オフィスの自販機に「これは絶対に欲しい！」という飲み物やカテゴリがあれば、自由にご記入ください。';

      const MANUFACTURER_FEATURES = {
        'コカ・コーラ': [
          { label: 'ブランド力・赤色デザイン', status: 'possible' },
          { label: 'マルチキャッシュレス対応', status: 'possible' },
          { label: '販売会社指定での設置', status: 'unavailable' },
        ],
        サントリー: [
          { label: 'BOSS などコーヒーが豊富', status: 'possible' },
          { label: '交通系IC・QR 決済', status: 'possible' },
          { label: '販売会社指定での設置', status: 'unavailable' },
        ],
        アサヒ: [
          { label: '三ツ矢・ウィルキンソン等炭酸系', status: 'possible' },
          { label: 'キャッシュレス対応', status: 'possible' },
          { label: '販売会社指定での設置', status: 'unavailable' },
        ],
        伊藤園: [
          { label: 'お茶・健康志向ラインアップ', status: 'possible' },
          { label: 'キャッシュレス対応', status: 'possible' },
          { label: '販売会社指定での設置', status: 'unavailable' },
        ],
      };

      const FALLBACK_IMAGE =
        'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="360" height="240" viewBox="0 0 360 240"><rect width="360" height="240" fill="%23f2f4f7"/><rect x="30" y="30" width="300" height="180" rx="12" fill="none" stroke="%23c3cad4" stroke-width="8"/><path d="M96 166l48-58 48 58 48-72 24 32" fill="none" stroke="%23c3cad4" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/><circle cx="138" cy="90" r="22" fill="%23d8dde5"/></svg>';

      const params = new URLSearchParams(window.location.search);
      const maker = params.get('maker') || makerFromTemplate || '';
      const folderId = params.get('folderId') || folderIdFromTemplate || '';

      function toEmbeddableUrl(src) {
        if (!src) return '';

        // If only an ID is passed, return the embeddable URL directly.
        if (!/^https?:\/\//i.test(src)) {
          return 'https://lh3.googleusercontent.com/d/' + src;
        }

        // Normalize common Drive share URLs to the embeddable googleusercontent format.
        const idMatch = src.match(/(?:\/d\/|id=)([\w-]{10,})/);
        if (idMatch && idMatch[1]) {
          return 'https://lh3.googleusercontent.com/d/' + idMatch[1];
        }

        return src;
      }

      function trimExtension(name) {
        if (!name) return '';
        const lastDotIndex = name.lastIndexOf('.');
        if (lastDotIndex <= 0) return name;
        return name.slice(0, lastDotIndex);
      }

      function createImageElement(src, alt) {
        const wrapper = document.createElement('div');
        wrapper.className = 'media-frame';

        const img = document.createElement('img');
        img.loading = 'lazy';
        img.alt = alt || '商品画像';
        img.referrerPolicy = 'no-referrer';

        const applyFallback = () => {
          img.onerror = null;
          img.src = FALLBACK_IMAGE;
        };

        img.onerror = applyFallback;
        img.src = toEmbeddableUrl(src) || FALLBACK_IMAGE;

        wrapper.appendChild(img);
        return wrapper;
      }

      function createFeaturesTable(items, categoryName) {
        const wrapper = document.createElement('div');
        wrapper.className = 'feature-table-wrapper';

        const table = document.createElement('table');
        table.className = 'feature-table';
        table.innerHTML = `
          <thead>
            <tr>
              <th>商品名</th>
              <th>価格</th>
              <th>カテゴリ</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');
        items.forEach((item) => {
          const tr = document.createElement('tr');
          const nameCell = document.createElement('td');
          nameCell.textContent = trimExtension(item.name) || '商品名未設定';

          const priceCell = document.createElement('td');
          priceCell.textContent = item.price ? `¥${item.price}` : '';

          const categoryCell = document.createElement('td');
          categoryCell.textContent = categoryName || 'カテゴリ未設定';

          tr.appendChild(nameCell);
          tr.appendChild(priceCell);
          tr.appendChild(categoryCell);
          tbody.appendChild(tr);
        });

        wrapper.appendChild(table);
        return wrapper;
      }

      function renderControls() {
        const controls = document.getElementById('controls');
        controls.innerHTML = `
          <div class="control-row">
            <div>
              <p class="eyebrow">質問１</p>
              <h2>メーカーを選んでください</h2>
              <p class="lead">${QUESTION1_DESCRIPTION}</p>
              <p class="note">${LINEUP_INSTRUCTION}</p>
            </div>
            <div>
              <p class="eyebrow">質問２</p>
              <h2>欲しいドリンクやカテゴリ</h2>
              <p class="lead">${QUESTION2_DESCRIPTION}</p>
            </div>
          </div>
        `;
      }

      function getMakerFeatures(name) {
        if (!name) return [];
        return MANUFACTURER_FEATURES[name] || [];
      }

      function renderFeatureList(name) {
        const features = getMakerFeatures(name);
        if (!features.length) return null;

        const list = document.createElement('ul');
        list.className = 'feature-list';

        features.forEach((feature) => {
          const item = document.createElement('li');
          item.className = 'feature-item';

          const badge = document.createElement('span');
          badge.className = 'feature-badge ' + (feature.status === 'possible' ? 'possible' : 'unavailable');
          badge.textContent = feature.status === 'possible' ? '可能' : '不可(販売会社決定)';

          const text = document.createElement('span');
          text.textContent = feature.label;

          item.appendChild(badge);
          item.appendChild(text);
          list.appendChild(item);
        });

        return list;
      }

      function setupSelectableCards(grid) {
        if (!grid) return;
        const cards = Array.from(grid.querySelectorAll('.card.selectable'));
        if (!cards.length) return;

        const updateState = (selectedCard) => {
          cards.forEach((card) => {
            const isSelected = card === selectedCard;
            card.classList.toggle('selected', isSelected);
            card.classList.toggle('dimmed', !isSelected);
          });
        };

        cards.forEach((card) => {
          card.addEventListener('click', () => {
            updateState(card);
          });
        });

        updateState(cards[0]);
      }

      function renderManufacturerSelection(manufacturers, container) {
        const list = document.createElement('section');
        list.className = 'block';
        list.innerHTML = `
          <div class="section-header">
            <div>
              <p class="eyebrow">質問１</p>
              <h2>メーカーを選択</h2>
              <p class="section-lead">画像をクリックして１社を選択してください。</p>
            </div>
          </div>
          <div class="card-grid manufacturer-grid"></div>
        `;

        const grid = list.querySelector('.manufacturer-grid');
        manufacturers.forEach((makerInfo) => {
          const card = document.createElement('article');
          card.className = 'card manufacturer-card selectable';

          const img = createImageElement(makerInfo.imageUrl, makerInfo.name);
          const name = document.createElement('h3');
          name.textContent = makerInfo.name;

          const features = renderFeatureList(makerInfo.name);

          card.appendChild(img);
          card.appendChild(name);
          if (features) card.appendChild(features);
          grid.appendChild(card);
        });

        container.innerHTML = '';
        container.appendChild(list);
        setupSelectableCards(grid);
      }

      function applySurveyHeaders(leadText) {
        document.getElementById('pageTitle').textContent = SURVEY_TITLE;
        document.getElementById('pageLead').textContent = leadText || QUESTION1_DESCRIPTION;
      }

      document.addEventListener('DOMContentLoaded', function () {
        google.script.run
          .withSuccessHandler(renderLineup)
          .withFailureHandler(showError)
          .getVendingLineup(maker, folderId);
      });

      function renderLineup(data) {
        const container = document.getElementById('lineupContainer');
        const manufacturer = (data && data.manufacturer) || maker || '';
        const categories = (data && data.categories) || [];
        const manufacturers = (data && data.manufacturers) || [];

        const shouldShowManufacturers = (!maker || maker === 'ラインアップ') && manufacturers.length;

        renderControls();
        applySurveyHeaders(`${QUESTION1_DESCRIPTION} ${LINEUP_INSTRUCTION}`);

        if (shouldShowManufacturers) {
          renderManufacturerSelection(manufacturers, container);
          return;
        }

        if (categories.length) {
          container.innerHTML = '';
          categories.forEach((category) => {
            const section = document.createElement('section');
            section.className = 'block';
            section.innerHTML = `
              <div class="section-header">
                <div>
                  <p class="eyebrow">自販機メーカー一覧</p>
                  <h2>${category.name || 'カテゴリー'}</h2>
                </div>
              </div>
              <div class="card-grid product-grid"></div>
            `;

            const grid = section.querySelector('.product-grid');
            if (!category.items || !category.items.length) {
              grid.innerHTML = '<div class="empty">商品が見つかりませんでした。</div>';
            } else {
              category.items.forEach((item) => {
                const card = document.createElement('article');
                card.className = 'card product-card';

                const itemDisplayName = trimExtension(item.name) || '商品名';

                const img = createImageElement(item.imageUrl, itemDisplayName || '商品画像');
                const badge = document.createElement('span');
                badge.className = 'badge';
                badge.textContent = category.name || 'カテゴリ';

                const meta = document.createElement('div');
                meta.className = 'meta';
                const maker = document.createElement('span');
                maker.className = 'maker';
                maker.textContent = manufacturer || 'メーカー不明';
                const price = document.createElement('span');
                price.className = 'price';
                price.textContent = item.price ? `¥${item.price}` : '';
                meta.appendChild(maker);
                if (item.price) meta.appendChild(price);

                const name = document.createElement('h3');
                name.textContent = itemDisplayName;

                card.appendChild(img);
                card.appendChild(badge);
                card.appendChild(meta);
                card.appendChild(name);
                grid.appendChild(card);
              });

              const featureTable = createFeaturesTable(category.items, category.name);
              section.appendChild(featureTable);
            }

            container.appendChild(section);
          });
          return;
        }

        if (manufacturers.length) {
          applySurveyHeaders(`${QUESTION1_DESCRIPTION} ${LINEUP_INSTRUCTION}`);
          renderManufacturerSelection(manufacturers, container);
          return;
        }

        container.innerHTML =
          '<section class="block"><div class="empty">現在表示できる商品情報がありません。商品の準備が整い次第、こちらに表示されます。</div></section>';
      }

      function showError(err) {
        const container = document.getElementById('lineupContainer');
        container.innerHTML = `<section class="block"><div class="empty">商品情報の取得に失敗しました。${
          err && err.message ? ` (詳細: ${err.message})` : ''
        }</div></section>`;
      }
    </script>
  </body>
</html>
