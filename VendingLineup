<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>商品ラインアップ</title>
    <style>
      :root {
        --bg: #fefefe;
        --card: #ffffff;
        --accent: #6c5ce7;
        --muted: #5f6368;
        --border: #e6e8f0;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: 'Noto Sans JP', 'Inter', system-ui, -apple-system, BlinkMacSystemFont,
          'Segoe UI', sans-serif;
        background: linear-gradient(180deg, #f7f7ff 0%, #ffffff 60%);
        color: #1f1f1f;
      }

      header {
        padding: 20px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .title {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .controls {
        margin: 0 24px 8px;
        padding: 16px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: 0 12px 30px rgba(31, 41, 55, 0.08);
      }

      .control-form {
        display: grid;
        gap: 12px;
      }

      .control-row {
        display: grid;
        gap: 12px;
      }

      @media (min-width: 768px) {
        .control-row {
          grid-template-columns: 1fr 1fr;
        }
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-weight: 600;
      }

      select,
      textarea {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 14px;
        font-family: inherit;
        background: #f9fafb;
      }

      textarea {
        min-height: 96px;
        resize: vertical;
      }

      .control-actions {
        display: flex;
        justify-content: flex-end;
      }

      h1 {
        margin: 0;
        font-size: 1.4rem;
      }

      .lead {
        margin: 0;
        color: var(--muted);
      }

      main {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 20px 32px;
      }

      .category {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
        margin-bottom: 18px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.05);
      }

      .category-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 12px;
      }

      .category-header h2 {
        margin: 0;
        font-size: 1.1rem;
      }

      .product-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      @media (min-width: 768px) {
        .product-grid {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
      }

      @media (min-width: 1024px) {
        .product-grid {
          grid-template-columns: repeat(4, minmax(0, 1fr));
        }
      }

      .manufacturer-grid {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .product-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px;
        background: #fbfbff;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .product-card img {
        width: 100%;
        height: 160px;
        object-fit: cover;
        border-radius: 10px;
        background: #f5f6fb;
        border: 1px solid #edf0f7;
      }

      .product-name {
        margin: 0;
        font-size: 1rem;
      }

      .product-price {
        color: #2563eb;
        font-weight: 800;
      }

      .manufacturer-card {
        gap: 12px;
      }

      .manufacturer-card img {
        height: 140px;
      }

      .button {
        display: inline-block;
        padding: 10px 14px;
        background: var(--accent);
        color: #fff;
        border-radius: 10px;
        font-weight: 700;
        text-decoration: none;
        text-align: center;
        transition: transform 0.12s ease;
        border: none;
        cursor: pointer;
      }

      .button:hover {
        transform: translateY(-1px);
      }

      .button.secondary {
        background: #fff;
        color: var(--accent);
        border: 1px solid var(--accent);
      }

      .empty {
        color: var(--muted);
      }

      .feature-table-wrapper {
        margin-top: 12px;
        overflow-x: auto;
      }

      .feature-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
      }

      .feature-table th,
      .feature-table td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }

      .feature-table tbody tr:last-child th,
      .feature-table tbody tr:last-child td {
        border-bottom: none;
      }

      .feature-table th {
        background: #f5f6fb;
        font-weight: 700;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="title">
        <h1 id="pageTitle">商品ラインアップ</h1>
        <p id="pageLead" class="lead">メーカー別に商品と価格をまとめています。</p>
      </div>
    </header>

    <section id="controls" class="controls"></section>
    <main id="lineupContainer"></main>

    <script>
      const makerFromTemplate = <?!= JSON.stringify(maker || '') ?>;
      const folderIdFromTemplate = <?!= JSON.stringify(folderId || '') ?>;

      const FALLBACK_IMAGE =
        'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="480" height="320" viewBox="0 0 480 320"><rect fill="%23f5f6fb" width="480" height="320"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%2399a1b3" font-size="24" font-family="Inter, sans-serif">No Image</text></svg>';

      const params = new URLSearchParams(window.location.search);
      const maker = params.get('maker') || makerFromTemplate || '';
      const folderId = params.get('folderId') || folderIdFromTemplate || '';
      const initialQuestion = params.get('question') || '';
      let currentQuestion = initialQuestion;

      function createImageElement(src, alt) {
        const img = document.createElement('img');
        img.src = src || FALLBACK_IMAGE;
        img.alt = alt || '商品画像';
        img.loading = 'lazy';
        img.onerror = () => {
          img.src = FALLBACK_IMAGE;
        };
        return img;
      }

      function createFeaturesTable(items, categoryName) {
        const wrapper = document.createElement('div');
        wrapper.className = 'feature-table-wrapper';

        const table = document.createElement('table');
        table.className = 'feature-table';
        table.innerHTML = `
          <thead>
            <tr>
              <th>商品名</th>
              <th>価格</th>
              <th>カテゴリ</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');
        items.forEach((item) => {
          const tr = document.createElement('tr');
          const nameCell = document.createElement('td');
          nameCell.textContent = item.name || '商品名未設定';

          const priceCell = document.createElement('td');
          priceCell.textContent = item.price ? `¥${item.price}` : '価格未設定';

          const categoryCell = document.createElement('td');
          categoryCell.textContent = categoryName || 'カテゴリ未設定';

          tr.appendChild(nameCell);
          tr.appendChild(priceCell);
          tr.appendChild(categoryCell);
          tbody.appendChild(tr);
        });

        wrapper.appendChild(table);
        return wrapper;
      }

      document.addEventListener('DOMContentLoaded', function () {
        google.script.run
          .withSuccessHandler(renderLineup)
          .withFailureHandler(showError)
          .getVendingLineup(maker, folderId);
      });

      function renderLineup(data) {
        const container = document.getElementById('lineupContainer');
        const manufacturer = (data && data.manufacturer) || maker || '';
        const categories = (data && data.categories) || [];
        const manufacturers = (data && data.manufacturers) || [];

        renderControls(manufacturers, manufacturer);

        if (categories.length) {
          document.getElementById('pageTitle').textContent = `${manufacturer || 'ラインアップ'} の商品ラインアップ`;
          document.getElementById('pageLead').textContent = 'カテゴリーごとに商品画像と価格をまとめました。';

          container.innerHTML = '';
          categories.forEach((category) => {
            const section = document.createElement('section');
            section.className = 'category';
            section.innerHTML = `
              <div class="category-header">
                <h2>${category.name || 'カテゴリー'}</h2>
                <span class="lead">${(category.items || []).length} 件</span>
              </div>
              <div class="product-grid"></div>
            `;

            const grid = section.querySelector('.product-grid');
            if (!category.items || !category.items.length) {
              grid.innerHTML = '<p class="empty">商品が見つかりませんでした。</p>';
            } else {
              category.items.forEach((item) => {
                const card = document.createElement('article');
                card.className = 'product-card';

                const img = createImageElement(item.imageUrl, item.name || '商品画像');
                const name = document.createElement('h3');
                name.className = 'product-name';
                name.textContent = item.name || '商品名';

                const price = document.createElement('div');
                price.className = 'product-price';
                price.textContent = item.price ? `¥${item.price}` : '価格未設定';

                card.appendChild(img);
                card.appendChild(name);
                card.appendChild(price);
                grid.appendChild(card);
              });

              const featureTable = createFeaturesTable(category.items, category.name);
              section.appendChild(featureTable);
            }

            container.appendChild(section);
          });
          return;
        }

        if (manufacturers.length) {
          document.getElementById('pageTitle').textContent = '自販機メーカー一覧';
          document.getElementById('pageLead').textContent = 'メーカーを選択して商品ラインアップをご覧ください。';

          const list = document.createElement('section');
          list.className = 'category';
          list.innerHTML = `
            <div class="category-header">
              <h2>メーカー</h2>
              <span class="lead">${manufacturers.length} 件</span>
            </div>
            <div class="product-grid manufacturer-grid"></div>
          `;

          const grid = list.querySelector('.product-grid');
          manufacturers.forEach((makerInfo) => {
            const card = document.createElement('article');
            card.className = 'product-card manufacturer-card';

            const img = createImageElement(makerInfo.imageUrl, makerInfo.name);
            const name = document.createElement('h3');
            name.className = 'product-name';
            name.textContent = makerInfo.name;

            const anchor = document.createElement('a');
            anchor.className = 'button';
            anchor.href = `?maker=${encodeURIComponent(makerInfo.name)}&folderId=${encodeURIComponent(makerInfo.folderId)}`;
            anchor.textContent = 'ラインアップを表示';

            card.appendChild(img);
            card.appendChild(name);
            card.appendChild(anchor);
            grid.appendChild(card);
          });

          container.innerHTML = '';
          container.appendChild(list);
          return;
        }

        container.innerHTML =
          '<p class="empty">現在表示できる商品情報がありません。商品の準備が整い次第、こちらに表示されます。</p>';
      }

      function renderControls(manufacturers, selectedMaker) {
        const controls = document.getElementById('controls');
        if (!controls) return;

        const options = manufacturers
          .map(
            (makerInfo) =>
              `<option value="${makerInfo.name}" ${selectedMaker === makerInfo.name ? 'selected' : ''}>${makerInfo.name}</option>`
          )
          .join('');

        controls.innerHTML = `
          <form id="makerForm" class="control-form">
            <div class="control-row">
              <label>
                自販機メーカー
                <select id="makerSelect" name="maker">
                  <option value="">メーカーを選択してください</option>
                  ${options}
                </select>
              </label>
              <label>
                自由記入の質問
                <textarea id="questionInput" name="question" placeholder="例: どの機種にアイスを追加できますか？"></textarea>
              </label>
            </div>
            <div class="control-actions">
              <button type="submit" class="button">ラインアップを見る</button>
            </div>
          </form>
        `;

        const makerSelect = document.getElementById('makerSelect');
        const questionInput = document.getElementById('questionInput');

        questionInput.value = currentQuestion || '';

        const form = document.getElementById('makerForm');
        form.addEventListener('submit', function (event) {
          event.preventDefault();
          currentQuestion = questionInput.value.trim();
          const selected = manufacturers.find((makerInfo) => makerInfo.name === makerSelect.value);
          const selectedFolderId = selected ? selected.folderId : '';

          const search = new URLSearchParams();
          if (makerSelect.value) search.set('maker', makerSelect.value);
          if (selectedFolderId) search.set('folderId', selectedFolderId);
          if (currentQuestion) search.set('question', currentQuestion);

          const newUrl = `${location.pathname}${search.toString() ? '?' + search.toString() : ''}`;
          window.history.replaceState({}, '', newUrl);

          google.script.run
            .withSuccessHandler(renderLineup)
            .withFailureHandler(showError)
            .getVendingLineup(makerSelect.value, selectedFolderId);
        });
      }

      function showError(err) {
        const container = document.getElementById('lineupContainer');
        container.innerHTML = `<p class="empty">商品情報の取得に失敗しました。${
          err && err.message ? ` (詳細: ${err.message})` : ''
        }</p>`;
      }
    </script>
  </body>
</html>
